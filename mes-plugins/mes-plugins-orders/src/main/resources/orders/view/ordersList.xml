<?xml version="1.0" encoding="UTF-8"?>
<!--

    ***************************************************************************
    Copyright (c) 2010 Qcadoo Limited
    Project: Qcadoo MES
    Version: 0.4.3

    This file is part of Qcadoo.

    Qcadoo is free software; you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published
    by the Free Software Foundation; either version 3 of the License,
    or (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty
    of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
    See the GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program; if not, write to the Free Software
    Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
    ***************************************************************************

-->
<view xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://schema.qcadoo.org/view" 
	xsi:schemaLocation="http://schema.qcadoo.org/view http://schema.qcadoo.org/view.xsd"
	name="ordersList"
	modelName="order"
	menuAccessible="true"
	defaultAuthorizationRole="ROLE_SUPERVISOR">
	
	<component type="window" name="window" reference="window">
		<ribbon>
			<group name="orderListActions">
				<bigButton name="new" icon="newIcon24.png" state="enabled" action="#{grid}.performNew;"/>
				<smallButton name="copy" icon="copyIcon16.png" action="#{grid}.performCopy;" state="disabled" />
				<smallButton name="delete" icon="deleteIcon16.png" action="#{grid}.performDelete;" state="disabled" />
			</group>
			<template name="standardGridTemplate" excludeGroups="actions"/>
			<group name="status">
				<bigButton name="activateOrder" icon="startIcon24.png"
					state="disabled">
					<script>
						<![CDATA[
							this.element.width(100);
							this.addOnChangeListener({
								onClick: function() {
									this.element.width(100);
									if (this.state == "begin") {
										if (window.confirm("#{translate(orders.ordersList.window.ribbon.status.activateOrder.confirm)}")) {
											#{grid}.performEvent('changeOrderStateForGrid', [true]);
										};
									} else if (this.state == "finish") {
										if (window.confirm("#{translate(orders.ordersList.window.ribbon.status.finishOrder.confirm)}")) {
											#{grid}.performEvent('changeOrderStateForGrid', [false]);
										};
									}
								}
							});
						]]>
					</script>
				</bigButton>
			</group>
			<group name="export">
				<smallButton name="print" icon="pdfIcon16.png"
					action="#{grid}.generateReportForEntity('orders','order','pdf')" state="disabled" />
				<smallButton name="generateListOfOrdersReport" icon="pdfIcon16.png"
					action="#{grid}.generateReportForEntity('orders','listOfOrdersReport','pdf')" state="disabled" />
			</group>
		</ribbon>
		<component type="grid" name="orders" reference="grid">
			<script>
				<![CDATA[
					var print = #{window}.getRibbonItem("export.print");
					var generateListOfOrdersReport = #{window}.getRibbonItem("export.generateListOfOrdersReport");
					var activateOrder = #{window}.getRibbonItem("status.activateOrder");
					var deleteButton = #{window}.getRibbonItem("orderListActions.delete");
					var copyButton = #{window}.getRibbonItem("orderListActions.copy");
					var listener = {
						onChange: function(selectedEntitiesArray) {
							if (!selectedEntitiesArray || selectedEntitiesArray.length == 0) {
								print.disable();
								generateListOfOrdersReport.disable();
								activateOrder.disable();
								deleteButton.disable();
								copyButton.disable();
							} else {
								generateListOfOrdersReport.enable();
								if (selectedEntitiesArray.length == 1) {
									print.enable();
									var selectedEntityStatus = selectedEntitiesArray[0].fields.state;
									if (selectedEntityStatus == '01pending') {
										activateOrder.enable();
										activateOrder.state = "begin";
										activateOrder.setLabel("#{translate(orders.ordersList.window.ribbon.status.activateOrder)}");
										activateOrder.setIcon('startIcon24.png');
									} else if (selectedEntityStatus == '02inProgress') {
										activateOrder.enable();
										activateOrder.state = "finish";
										activateOrder.setLabel("#{translate(orders.ordersList.window.ribbon.status.finishOrder)}");
										activateOrder.setIcon('acceptIcon24.png');
									} else {
										activateOrder.disable();
									}
								} else {
									print.disable("#{translate(moreThanOneRecordSelected)}");
									activateOrder.disable("#{translate(moreThanOneRecordSelected)}");
								}
								copyButton.enable();
								var noneClosed = true;
								for (var i in selectedEntitiesArray) {
									if (selectedEntitiesArray[i].fields.state == "03done") {
										noneClosed = false;
										break;
									}
								}
								if (noneClosed) {
									deleteButton.enable();
								} else {
									deleteButton.disable("#{translate(orders.orders.ribbon.message.someStateIsDone)}");
								}
							}
						}
					}
					this.addOnChangeListener(listener);
				]]>
			</script>
			<option type="column" name="number" fields="number" link="true"
				width="50" />
			<option type="column" name="name" fields="name" link="true" />
			<option type="column" name="state" fields="state" width="40" />
			<option type="column" name="dateFrom" fields="dateFrom"
				width="40" />
			<option type="column" name="dateTo" fields="dateTo" width="40" />
			<option type="order" column="number" direction="desc" />
			<option type="correspondingView" value="orders/orderDetails" />
			<option type="correspondingComponent" value="form" />
			<option type="searchable" value="name,number,state,dateFrom,dateTo" />
			<option type="orderable" value="name,number,state,dateFrom,dateTo" />
			<option type="fullscreen" value="true" />
			<option type="multiselect" value="true" />
			<option type="hasPredefinedFilters" value="true" />
			<predefinedFilters>
				<predefinedFilter name="all">
				</predefinedFilter>
				<predefinedFilter name="pending">
					<filterRestriction column="state" value="01pending" />
					<filterOrder column="dateFrom" direction="asc" />
				</predefinedFilter>
				<predefinedFilter name="inProgress">
					<filterRestriction column="state" value="02inProgress" />
					<filterOrder column="dateTo" direction="asc" />
				</predefinedFilter>
				<predefinedFilter name="overduePending">
					<filterRestriction column="state" value="01pending" />
					<filterRestriction column="dateTo" value="&lt;= @{yesterday}" />
				</predefinedFilter>
				<predefinedFilter name="overdueInProgress">
					<filterRestriction column="state" value="02inProgress" />
					<filterRestriction column="dateTo" value="&lt;= @{yesterday}" />
				</predefinedFilter>
				<predefinedFilter name="startingToday">
					<filterRestriction column="state" value="01pending" />
					<filterRestriction column="dateFrom" value="@{today}" />
				</predefinedFilter>
				<predefinedFilter name="startingTomorrow">
					<filterRestriction column="state" value="01pending" />
					<filterRestriction column="dateFrom" value="@{tomorrow}" />
				</predefinedFilter>
			</predefinedFilters>
			<listener event="changeOrderStateForGrid" class="com.qcadoo.mes.orders.OrderService"
				method="changeOrderStateForGrid" />
		</component>
		<option type="fixedHeight" value="true" />
		<option type="header" value="false" />
	</component>
</view>